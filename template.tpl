___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.

___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Ethyca CMP",
  "brand": {
    "id": "ethyca",
    "displayName": "Ethyca",
    "thumbnail": "data:image/png;base64,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\u003d"
  },
  "description": "Manage GTM consent using Fides.js",
  "containerContexts": ["WEB"]
}

___TEMPLATE_PARAMETERS___

[
  {
    "type": "GROUP",
    "name": "Defaults",
    "displayName": "Consent Defaults",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "default_analytics_storage",
        "displayName": "analytics_storage",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "granted",
            "displayValue": "Granted"
          },
          {
            "value": "denied",
            "displayValue": "Denied"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied"
      },
      {
        "type": "SELECT",
        "name": "default_ad_storage",
        "displayName": "ad_storage",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "granted",
            "displayValue": "Granted"
          },
          {
            "value": "denied",
            "displayValue": "Denied"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied"
      },
      {
        "type": "SELECT",
        "name": "default_ad_user_data",
        "displayName": "ad_user_data",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "granted",
            "displayValue": "Granted"
          },
          {
            "value": "denied",
            "displayValue": "Denied"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied"
      },
      {
        "type": "SELECT",
        "name": "default_ad_personalization",
        "displayName": "ad_personalization",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "granted",
            "displayValue": "Granted"
          },
          {
            "value": "denied",
            "displayValue": "Denied"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied"
      },
      {
        "type": "SELECT",
        "name": "default_personalization_storage",
        "displayName": "personalization_storage",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "granted",
            "displayValue": "Granted"
          },
          {
            "value": "denied",
            "displayValue": "Denied"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "denied"
      },
      {
        "type": "SELECT",
        "name": "default_functionality_storage",
        "displayName": "functionality_storage",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "granted",
            "displayValue": "Granted"
          },
          {
            "value": "denied",
            "displayValue": "Denied"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "granted"
      },
      {
        "type": "SELECT",
        "name": "default_security_storage",
        "displayName": "security_storage",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "granted",
            "displayValue": "Granted"
          },
          {
            "value": "denied",
            "displayValue": "Denied"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "granted"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "Regional Consent Defaults",
    "displayName": "Regional Consent Defaults",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "PARAM_TABLE",
        "name": "regionalOverrides",
        "displayName": "Regional Consent Defaults",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "region",
              "displayName": "Region",
              "simpleValueType": true,
              "valueHint": "US-CA",
              "help": "Comma separated list of ISO 3166-2 regions"
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "SELECT",
              "name": "analytics_storage",
              "displayName": "analytics_storage",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "ad_storage",
              "displayName": "ad_storage",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "ad_user_data",
              "displayName": "ad_user-data",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "ad_personalization",
              "displayName": "ad_personalization",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "personalization_storage",
              "displayName": "personalization_storage",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "denied"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "functionality_storage",
              "displayName": "functionality_storage",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "SELECT",
              "name": "security_storage",
              "displayName": "security_storage",
              "macrosInSelect": true,
              "selectItems": [
                {
                  "value": "granted",
                  "displayValue": "Granted"
                },
                {
                  "value": "denied",
                  "displayValue": "Denied"
                }
              ],
              "simpleValueType": true,
              "defaultValue": "granted"
            },
            "isUnique": false
          }
        ],
        "help": "Override consent defaults by region here.",
        "newRowButtonText": "Override regional default",
        "defaultValue": [
          {
            "region": "US",
            "analytics_storage": "granted",
            "ad_storage": "granted",
            "ad_user_data": "granted",
            "ad_personalization": "granted",
            "personalization_storage": "granted",
            "functionality_storage": "granted",
            "security_storage": "granted"
          },
          {
            "region": "CA",
            "analytics_storage": "granted",
            "ad_storage": "granted",
            "ad_user_data": "granted",
            "ad_personalization": "granted",
            "personalization_storage": "granted",
            "functionality_storage": "granted",
            "security_storage": "granted"
          },
          {
            "region": "CA-QC",
            "analytics_storage": "denied",
            "ad_storage": "denied",
            "ad_user_data": "denied",
            "ad_personalization": "denied",
            "personalization_storage": "denied",
            "functionality_storage": "denied",
            "security_storage": "granted"
          },
          {
            "region": "BE,EL,LT,PT,BG,ES,LU,RO,CZ,FR,HU,SI,DK,HR,MT,SK,DE,IT,NL,FI,EE,CY,AT,SE,IE,LV,PL,IS,NO,LI,CH",
            "analytics_storage": "denied",
            "ad_storage": "denied",
            "ad_user_data": "denied",
            "ad_personalization": "denied",
            "personalization_storage": "denied",
            "functionality_storage": "denied",
            "security_storage": "granted"
          }
        ]
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "Settings",
    "displayName": "Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "fides",
        "displayName": "Fides consent",
        "simpleValueType": true,
        "defaultValue": "{{Fides}}",
        "help": "A helper field to access the Fides consent from the events. This usually doesn\u0027t need to be changed."
      },
      {
        "type": "TEXT",
        "name": "event",
        "displayName": "Event",
        "simpleValueType": true,
        "defaultValue": "{{Event}}",
        "help": "A helper field to access the event names. This usually doesn\u0027t need to be changed."
      },
      {
        "type": "TEXT",
        "name": "waitForUpdate",
        "displayName": "Wait for update",
        "simpleValueType": true,
        "defaultValue": 1000,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "NON_NEGATIVE_NUMBER"
          }
        ],
        "help": "Time in milliseconds to wait for Fides.js consent values before using the defaults."
      },
      {
        "type": "TEXT",
        "name": "scriptUrl",
        "displayName": "Fides.js Script URL",
        "simpleValueType": true,
        "help": "The URL should be under ethyca.com domain. Leave blank when Fides.js is already loaded on the page."
      }
    ]
  }
]

___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "functionality_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "personalization_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "security_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://*.ethyca.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": false
  }
]

___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const injectScript = require("injectScript");
const log = require("logToConsole");
const setDefaultConsentState = require("setDefaultConsentState");
const updateConsentState = require("updateConsentState");

/*
 * Because we can't rely on Fides.js to be initialized or even loaded before the GTM container, we use
 * the GTM events to update the consent state. If Fides.js runs before this, it will push the events to
 * the dataLayer and they will be processed asynchronously when the GTM container loads. To get the Fides*
 * events, the page loading Fides.js needs to call Fides.gtm() immediately after.
 * 
 * The events we are interested in:
 *
 *   gtm.init_consent  - The default consent initialization event that GTM fires when the container loads
 *   FidesInitialized  - The event that Fides.js fires when it has initialized
 *   FidesUpdating     - This is the event that Fides.js fires when the consent state is being updated
 * 
 * The expected behavior for a consent mode template is to set the default consent state when the GTM
 * container loads and then update it with the actual user preference. The consent is not saved across
 * page loads, which is why we call updateConsentState on FidesInitialized.
 */

// Time to wait for Fides.js to initialize and update the consent
const WAIT_FOR_UPDATE = data.waitForUpdate;

// Map between GTM and Fides consent types
const CONSENT_MAP = {
  ad_storage: [
    "marketing",
    "data_sales_and_sharing",
    "data_sales_sharing_gpp_us_state",
    "data_sharing_gpp_us_state",
    "data_sales_gpp_us_state",
    "targeted_advertising_gpp_us_state",
  ],
  ad_user_data: [
    "marketing",
    "data_sales_and_sharing",
    "data_sales_sharing_gpp_us_state",
    "data_sharing_gpp_us_state",
    "data_sales_gpp_us_state",
    "targeted_advertising_gpp_us_state",
  ],
  ad_personalization: [
    "marketing",
    "data_sales_and_sharing",
    "data_sales_sharing_gpp_us_state",
    "data_sharing_gpp_us_state",
    "data_sales_gpp_us_state",
    "targeted_advertising_gpp_us_state",
  ],
  analytics_storage: ["analytics"],
  functionality_storage: ["functional"],
  personalization_storage: ["functional"],
  security_storage: ["essential"],
};

if (data.event === "gtm.init_consent") {
  // The default Consent Initialization trigger fired
  log("Setting the default consent state");
  if (data.regionalOverrides) {
    for (const defaults of data.regionalOverrides) {
      const obj = {};
      for (const key in defaults) {
        obj[key] = defaults[key];
      }
      obj.region = defaults.region.split(",").map((r) => r.trim());
      obj.wait_for_update = WAIT_FOR_UPDATE;
      setDefaultConsentState(obj);
    }
  }
  
  const consent = {};
  for (const key in CONSENT_MAP) {
    consent[key] = data["default_" + key];
  }
  consent.wait_for_update = WAIT_FOR_UPDATE;
  setDefaultConsentState(consent);

  if (data.scriptUrl) {
    log("Injecting Fides.js");
    return injectScript(data.scriptUrl, data.gtmOnSuccess, data.gtmOnFailure);
  }

} else if (data.fides && (data.event === "FidesInitialized" || data.event === "FidesUpdating")) {
  // We use both FidesInitialized and FidesUpdating events to update the consent
  log("Updating the consent from Fides");
  updateGTMConsent(data.fides.consent);
}

return data.gtmOnSuccess();

// Only function definitions below this line

function updateGTMConsent(fidesConsent) {
  const gtmConsent = {};

  for (const key in CONSENT_MAP) {
    for (const value of CONSENT_MAP[key]) {
      if (fidesConsent[value] === true) {
        gtmConsent[key] = "granted";
        break;
      } else if (fidesConsent[value] === false) {
        gtmConsent[key] = "denied";
        break;
      }
    }

    // If none of the values are present, then fall back to the default from the data object
    if (gtmConsent[key] === undefined) {
      gtmConsent[key] = data["default_" + key];
    }
  }

  updateConsentState(gtmConsent);
}

___TESTS___

scenarios: []

